<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="陪月书"><title>React 源码解读路线[0] · 陪月书的博客</title><meta name="description" content="每次看这种框架的源码的时候，都让人感觉摸不着头脑，不过我们可以通过我们平时的使用，来一步步了解React的实现。使用深度优先搜索来学习这个
从最简单的开始：

使用ReactDom, 在id=root的dom节点上插入h1,我们去看源码的声明

12345ReactDOM.render(  &amp;lt;"><meta name="keywords" content="Web, FE, MachineLearning, DeepLearning"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">陪月书的博客</a></h3><div class="description"><p>有的人20岁就死了，80岁才埋</p></div></div></div><ul class="social-links"><li><a href="http://github.com/Yulight1401"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img src="/images/myIcon.jpeg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>React 源码解读路线[0]</a></h3></div><div class="post-content"><p>每次看这种框架的源码的时候，都让人感觉摸不着头脑，不过我们可以通过我们平时的使用，来一步步了解React的实现。使用深度优先搜索来学习这个</p>
<p>从最简单的开始：</p>
<blockquote>
<p>使用ReactDom, 在id=root的dom节点上插入h1,我们去看源码的声明</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;h1&gt;Hello, world!&lt;/h1&gt;,</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">'root'</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>源码地址: <a href="https://github.com/facebook/react/blob/master/packages/react-dom/src/client/ReactDOM.js" target="_blank" rel="noopener">https://github.com/facebook/react/blob/master/packages/react-dom/src/client/ReactDOM.js</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ReactDOM: <span class="built_in">Object</span> = &#123;</span><br><span class="line"> ...</span><br><span class="line"> render(</span><br><span class="line">    element: React$Element&lt;any&gt;, <span class="comment">// any为flow的类型检查，即任何类型的ReactElement</span></span><br><span class="line">    container: DOMContainer, <span class="comment">// DomContainer类型</span></span><br><span class="line">    callback: ?<span class="built_in">Function</span>, <span class="comment">// ?为flow的optional，类型为Function 选填</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> legacyRenderSubtreeIntoContainer(</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      element,</span><br><span class="line">      container,</span><br><span class="line">      <span class="literal">false</span>,</span><br><span class="line">      callback,</span><br><span class="line">    );</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>官方解释:</p>
<p>Render a React element into the DOM in the supplied container and return a reference to the component (or returns null for stateless components).</p>
<p>If the React element was previously rendered into container, this will perform an update on it and only mutate the DOM as necessary to reflect the latest React element.</p>
<p>If the optional callback is provided, it will be executed after the component is rendered or updated.</p>
<p>可以很直接， 可见初始化时，又调用了legacyRenderSubtreeIntoContainer这个函数，接着看</p>
<hr>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">legacyRenderSubtreeIntoContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  parentComponent: ?React$Component&lt;any, any&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  children: ReactNodeList,</span></span></span><br><span class="line"><span class="function"><span class="params">  container: DOMContainer,</span></span></span><br><span class="line"><span class="function"><span class="params">  forceHydrate: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback: ?Function,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Ensure all entry points contain this check</span></span><br><span class="line">  invariant(</span><br><span class="line">    isValidContainer(container),</span><br><span class="line">    <span class="string">'Target container is not a DOM element.'</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    topLevelUpdateWarnings(container);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Without `any` type, Flow says "Property cannot be accessed on any</span></span><br><span class="line">  <span class="comment">// member of intersection type." Whyyyyyy.</span></span><br><span class="line">  <span class="keyword">let</span> root: Root = (container._reactRootContainer: any);<span class="comment">// 获取根</span></span><br><span class="line">  <span class="comment">// 如果root没有实例化过，则实例化，防止被重复调用</span></span><br><span class="line">  <span class="keyword">if</span> (!root) &#123;</span><br><span class="line">    <span class="comment">// Initial mount</span></span><br><span class="line">    root = container._reactRootContainer = legacyCreateRootFromDOMContainer(</span><br><span class="line">      container,</span><br><span class="line">      forceHydrate,</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// 如果有callback，则包装一层</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> callback === <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> originalCallback = callback;</span><br><span class="line">      callback = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> instance = DOMRenderer.getPublicRootInstance(root._internalRoot);</span><br><span class="line">        originalCallback.call(instance);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Initial mount should not be batched.</span></span><br><span class="line">    DOMRenderer.unbatchedUpdates(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (parentComponent != <span class="literal">null</span>) &#123;</span><br><span class="line">        root.legacy_renderSubtreeIntoContainer(</span><br><span class="line">          parentComponent,</span><br><span class="line">          children,</span><br><span class="line">          callback,</span><br><span class="line">        );</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        root.render(children, callback);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 已经有实例的化</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> callback === <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> originalCallback = callback;</span><br><span class="line">      callback = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> instance = DOMRenderer.getPublicRootInstance(root._internalRoot);</span><br><span class="line">        originalCallback.call(instance);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 直接Update</span></span><br><span class="line">    <span class="keyword">if</span> (parentComponent != <span class="literal">null</span>) &#123;</span><br><span class="line">      root.legacy_renderSubtreeIntoContainer(</span><br><span class="line">        parentComponent,</span><br><span class="line">        children,</span><br><span class="line">        callback,</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      root.render(children, callback);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 返回根节点实例</span></span><br><span class="line">  <span class="keyword">return</span> DOMRenderer.getPublicRootInstance(root._internalRoot);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可见根节点为包装对象，调用render时，先判断是否已经实例化了，没有就由legacyCreateRootFromDOMContainer创建，有的化就直接更新。接下来可以看看它时如何更新的：我们可以直接找root.legacy_renderSubtreeIntoContainer</p>
<hr>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ReactRoot.prototype.legacy_renderSubtreeIntoContainer = <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  parentComponent: ?React$Component&lt;any, any&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  children: ReactNodeList,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback: ?(</span>) =&gt; <span class="title">mixed</span>,</span></span><br><span class="line"><span class="function">): <span class="title">Work</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> root = <span class="keyword">this</span>._internalRoot;</span><br><span class="line">  <span class="keyword">const</span> work = <span class="keyword">new</span> ReactWork();</span><br><span class="line">  callback = callback === <span class="literal">undefined</span> ? <span class="literal">null</span> : callback;</span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    warnOnInvalidCallback(callback, <span class="string">'render'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">    work.then(callback);</span><br><span class="line">  &#125;</span><br><span class="line">  DOMRenderer.updateContainer(children, root, parentComponent, work._onCommit);</span><br><span class="line">  <span class="keyword">return</span> work;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我们还需要再找DOMRenderer.updateContainer，继续</p>
<hr>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> DOMRenderer = ReactFiberReconciler(&#123;.../</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ReactFiberReconciler <span class="keyword">from</span> <span class="string">'react-reconciler'</span>;</span><br></pre></td></tr></table></figure>
<p>在DOMRenderer没有中找到updateContianer, 那么它一定在ReactFiberReconciler里，继续，可见目前React基本上把很多操作都使用Fiber算法调度了，那么先给出Fiber的一个数据结构方便理解：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">type Fiber = &#123;</span><br><span class="line">  <span class="comment">// These fields conceptually belong to an instance of the component</span></span><br><span class="line">  <span class="comment">// this fiber is related to.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Tag identifying the type of fiber.</span></span><br><span class="line">  tag: TypeOfWork,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Unique identifier of this child.</span></span><br><span class="line">  key: <span class="literal">null</span> | string,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The function/class/module associated with this fiber.</span></span><br><span class="line">  type: any,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The local state associated with this fiber.</span></span><br><span class="line">  stateNode: any,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Remaining fields belong to Fiber</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// The Fiber to return to after finishing processing this one.</span></span><br><span class="line">  <span class="comment">// This is effectively the parent, but there can be multiple parents (two)</span></span><br><span class="line">  <span class="comment">// so this is only the parent of the thing we're currently processing.</span></span><br><span class="line">  <span class="comment">// It is conceptually the same as the return address of a stack frame.</span></span><br><span class="line">  <span class="keyword">return</span>: Fiber | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Singly Linked List Tree Structure.</span></span><br><span class="line">  child: Fiber | <span class="literal">null</span>,</span><br><span class="line">  sibling: Fiber | <span class="literal">null</span>,</span><br><span class="line">  index: number,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The ref last used to attach this node.</span></span><br><span class="line">  <span class="comment">// I'll avoid adding an owner field for prod and model that as functions.</span></span><br><span class="line">  ref: <span class="literal">null</span> | <span class="function">(<span class="params">((handle: mixed</span>) =&gt;</span> <span class="keyword">void</span>) &amp; &#123;<span class="attr">_stringRef</span>: ?string&#125;),</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Input is the data coming into process this fiber. Arguments. Props.</span></span><br><span class="line">  pendingProps: any, <span class="comment">// This type will be more specific once we overload the tag.</span></span><br><span class="line">  memoizedProps: any, <span class="comment">// The props used to create the output.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// A queue of state updates and callbacks.</span></span><br><span class="line">  updateQueue: UpdateQueue | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The state used to create the output</span></span><br><span class="line">  memoizedState: any,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Bitfield that describes properties about the fiber and its subtree. E.g.</span></span><br><span class="line">  <span class="comment">// the AsyncUpdates flag indicates whether the subtree should be async-by-</span></span><br><span class="line">  <span class="comment">// default. When a fiber is created, it inherits the internalContextTag of its</span></span><br><span class="line">  <span class="comment">// parent. Additional flags can be set at creation time, but after than the</span></span><br><span class="line">  <span class="comment">// value should remain unchanged throughout the fiber's lifetime, particularly</span></span><br><span class="line">  <span class="comment">// before its child fibers are created.</span></span><br><span class="line">  internalContextTag: TypeOfInternalContext,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Effect</span></span><br><span class="line">  effectTag: TypeOfSideEffect,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Singly linked list fast path to the next fiber with side-effects.</span></span><br><span class="line">  nextEffect: Fiber | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The first and last fiber with side-effect within this subtree. This allows</span></span><br><span class="line">  <span class="comment">// us to reuse a slice of the linked list when we reuse the work done within</span></span><br><span class="line">  <span class="comment">// this fiber.</span></span><br><span class="line">  firstEffect: Fiber | <span class="literal">null</span>,</span><br><span class="line">  lastEffect: Fiber | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This will be used to quickly determine if a subtree has no pending changes.</span></span><br><span class="line">  pendingWorkPriority: PriorityLevel,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This value represents the priority level that was last used to process this</span></span><br><span class="line">  <span class="comment">// component. This indicates whether it is better to continue from the</span></span><br><span class="line">  <span class="comment">// progressed work or if it is better to continue from the current state.</span></span><br><span class="line">  progressedPriority: PriorityLevel,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If work bails out on a Fiber that already had some work started at a lower</span></span><br><span class="line">  <span class="comment">// priority, then we need to store the progressed work somewhere. This holds</span></span><br><span class="line">  <span class="comment">// the started child set until we need to get back to working on it. It may</span></span><br><span class="line">  <span class="comment">// or may not be the same as the "current" child.</span></span><br><span class="line">  progressedChild: Fiber | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// When we reconcile children onto progressedChild it is possible that we have</span></span><br><span class="line">  <span class="comment">// to delete some child fibers. We need to keep track of this side-effects so</span></span><br><span class="line">  <span class="comment">// that if we continue later on, we have to include those effects. Deletions</span></span><br><span class="line">  <span class="comment">// are added in the reverse order from sibling pointers.</span></span><br><span class="line">  progressedFirstDeletion: Fiber | <span class="literal">null</span>,</span><br><span class="line">  progressedLastDeletion: Fiber | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This is a pooled version of a Fiber. Every fiber that gets updated will</span></span><br><span class="line">  <span class="comment">// eventually have a pair. There are cases when we can clean up pairs to save</span></span><br><span class="line">  <span class="comment">// memory if we need to.</span></span><br><span class="line">  alternate: Fiber | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Conceptual aliases</span></span><br><span class="line">  <span class="comment">// workInProgress : Fiber -&gt;  alternate The alternate used for reuse happens</span></span><br><span class="line">  <span class="comment">// to be the same as work in progress.</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Hey there! Care <span class="keyword">for</span> a chat?</span><br></pre></td></tr></table></figure>
<hr>
<p><a href="https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberReconciler.js" target="_blank" rel="noopener">https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberReconciler.js</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">updateContainer(</span><br><span class="line">      element: ReactNodeList,</span><br><span class="line">      container: OpaqueRoot,</span><br><span class="line">      parentComponent: ?React$Component&lt;any, any&gt;,</span><br><span class="line">      callback: ?<span class="built_in">Function</span>,</span><br><span class="line">    ): ExpirationTime &#123;</span><br><span class="line">      <span class="keyword">const</span> current = container.current;</span><br><span class="line">      <span class="keyword">const</span> expirationTime = computeExpirationForFiber(current);</span><br><span class="line">      <span class="keyword">return</span> updateContainerAtExpirationTime(</span><br><span class="line">        element,</span><br><span class="line">        container,</span><br><span class="line">        parentComponent,</span><br><span class="line">        expirationTime,</span><br><span class="line">        callback,</span><br><span class="line">      );</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>
<p>可见这个函数只计算了Fiber算法所需要的时间参数，真正渲染的是updateContainerAtExpirationTime,以实现fiber算法。</p>
<hr>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateContainerAtExpirationTime</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    element: ReactNodeList,</span></span></span><br><span class="line"><span class="function"><span class="params">    container: OpaqueRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">    parentComponent: ?React$Component&lt;any, any&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">    expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params">    callback: ?Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>) </span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> If this is a nested container, this won't be the root.</span></span><br><span class="line">    <span class="keyword">const</span> current = container.current;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="keyword">if</span> (ReactFiberInstrumentation.debugTool) &#123;</span><br><span class="line">        <span class="keyword">if</span> (current.alternate === <span class="literal">null</span>) &#123;</span><br><span class="line">          ReactFiberInstrumentation.debugTool.onMountContainer(container);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (element === <span class="literal">null</span>) &#123;</span><br><span class="line">          ReactFiberInstrumentation.debugTool.onUnmountContainer(container);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          ReactFiberInstrumentation.debugTool.onUpdateContainer(container);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> context = getContextForSubtree(parentComponent);</span><br><span class="line">    <span class="keyword">if</span> (container.context === <span class="literal">null</span>) &#123;</span><br><span class="line">      container.context = context;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      container.pendingContext = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> scheduleRootUpdate(current, element, expirationTime, callback);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>接着看scheduleRootUpdate</p>
<hr>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">scheduleRootUpdate</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    current: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    element: ReactNodeList,</span></span></span><br><span class="line"><span class="function"><span class="params">    expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params">    callback: ?Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        ReactDebugCurrentFiber.phase === <span class="string">'render'</span> &amp;&amp;</span><br><span class="line">        ReactDebugCurrentFiber.current !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        !didWarnAboutNestedUpdates</span><br><span class="line">      ) &#123;</span><br><span class="line">        didWarnAboutNestedUpdates = <span class="literal">true</span>;</span><br><span class="line">        warning(</span><br><span class="line">          <span class="literal">false</span>,</span><br><span class="line">          <span class="string">'Render methods should be a pure function of props and state; '</span> +</span><br><span class="line">            <span class="string">'triggering nested component updates from render is not allowed. '</span> +</span><br><span class="line">            <span class="string">'If necessary, trigger nested updates in componentDidUpdate.\n\n'</span> +</span><br><span class="line">            <span class="string">'Check the render method of %s.'</span>,</span><br><span class="line">          getComponentName(ReactDebugCurrentFiber.current) || <span class="string">'Unknown'</span>,</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    callback = callback === <span class="literal">undefined</span> ? <span class="literal">null</span> : callback;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      warning(</span><br><span class="line">        callback === <span class="literal">null</span> || <span class="keyword">typeof</span> callback === <span class="string">'function'</span>,</span><br><span class="line">        <span class="string">'render(...): Expected the last optional `callback` argument to be a '</span> +</span><br><span class="line">          <span class="string">'function. Instead received: %s.'</span>,</span><br><span class="line">        callback,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> update = &#123;</span><br><span class="line">      expirationTime,</span><br><span class="line">      partialState: &#123;element&#125;,</span><br><span class="line">      callback,</span><br><span class="line">      isReplace: <span class="literal">false</span>,</span><br><span class="line">      isForced: <span class="literal">false</span>,</span><br><span class="line">      next: <span class="literal">null</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    insertUpdateIntoFiber(current, update);</span><br><span class="line">    scheduleWork(current, expirationTime);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> expirationTime;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>查找 scheduleWork</p>
<hr>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">    computeUniqueAsyncExpiration,</span><br><span class="line">    computeExpirationForFiber,</span><br><span class="line">    scheduleWork,</span><br><span class="line">    requestWork,</span><br><span class="line">    flushRoot,</span><br><span class="line">    batchedUpdates,</span><br><span class="line">    unbatchedUpdates,</span><br><span class="line">    flushSync,</span><br><span class="line">    deferredUpdates,</span><br><span class="line">  &#125; = ReactFiberScheduler(config);</span><br></pre></td></tr></table></figure>
<hr>
<p>查找 ReactFiberScheduler</p>
<hr>
<p><a href="https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberScheduler.js" target="_blank" rel="noopener">https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberScheduler.js</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>&lt;<span class="title">T</span>, <span class="title">P</span>, <span class="title">I</span>, <span class="title">TI</span>, <span class="title">HI</span>, <span class="title">PI</span>, <span class="title">C</span>, <span class="title">CC</span>, <span class="title">CX</span>, <span class="title">PL</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  config: HostConfig&lt;T, P, I, TI, HI, PI, C, CC, CX, PL&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> hostContext = ReactFiberHostContext(config);</span><br><span class="line">  <span class="keyword">const</span> hydrationContext: HydrationContext&lt;C, CX&gt; = ReactFiberHydrationContext(</span><br><span class="line">    config,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> &#123;popHostContainer, popHostContext, resetHostContainer&#125; = hostContext;</span><br><span class="line">  <span class="keyword">const</span> &#123;beginWork, beginFailedWork&#125; = ReactFiberBeginWork(</span><br><span class="line">    config,</span><br><span class="line">    hostContext,</span><br><span class="line">    hydrationContext,</span><br><span class="line">    scheduleWork,</span><br><span class="line">    computeExpirationForFiber,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> &#123;completeWork&#125; = ReactFiberCompleteWork(</span><br><span class="line">    config,</span><br><span class="line">    hostContext,</span><br><span class="line">    hydrationContext,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    commitResetTextContent,</span><br><span class="line">    commitPlacement,</span><br><span class="line">    commitDeletion,</span><br><span class="line">    commitWork,</span><br><span class="line">    commitLifeCycles,</span><br><span class="line">    commitAttachRef,</span><br><span class="line">    commitDetachRef,</span><br><span class="line">  &#125; = ReactFiberCommitWork(config, captureError);</span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    now,</span><br><span class="line">    scheduleDeferredCallback,</span><br><span class="line">    cancelDeferredCallback,</span><br><span class="line">    useSyncScheduling,</span><br><span class="line">    prepareForCommit,</span><br><span class="line">    resetAfterCommit,</span><br><span class="line">  &#125; = config;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Represents the current time in ms.</span></span><br><span class="line">  <span class="keyword">const</span> startTime = now();</span><br><span class="line">  <span class="keyword">let</span> mostRecentCurrentTime: ExpirationTime = msToExpirationTime(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Used to ensure computeUniqueAsyncExpiration is monotonically increases.</span></span><br><span class="line">  <span class="keyword">let</span> lastUniqueAsyncExpiration: number = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Represents the expiration time that incoming updates should use. (If this</span></span><br><span class="line">  <span class="comment">// is NoWork, use the default strategy: async updates in async mode, sync</span></span><br><span class="line">  <span class="comment">// updates in sync mode.)</span></span><br><span class="line">  <span class="keyword">let</span> expirationContext: ExpirationTime = NoWork;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> isWorking: boolean = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The next work in progress fiber that we're currently working on.</span></span><br><span class="line">  <span class="keyword">let</span> nextUnitOfWork: Fiber | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">let</span> nextRoot: FiberRoot | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// The time at which we're currently rendering work.</span></span><br><span class="line">  <span class="keyword">let</span> nextRenderExpirationTime: ExpirationTime = NoWork;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The next fiber with an effect that we're currently committing.</span></span><br><span class="line">  <span class="keyword">let</span> nextEffect: Fiber | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Keep track of which fibers have captured an error that need to be handled.</span></span><br><span class="line">  <span class="comment">// Work is removed from this collection after componentDidCatch is called.</span></span><br><span class="line">  <span class="keyword">let</span> capturedErrors: <span class="built_in">Map</span>&lt;Fiber, CapturedError&gt; | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// Keep track of which fibers have failed during the current batch of work.</span></span><br><span class="line">  <span class="comment">// This is a different set than capturedErrors, because it is not reset until</span></span><br><span class="line">  <span class="comment">// the end of the batch. This is needed to propagate errors correctly if a</span></span><br><span class="line">  <span class="comment">// subtree fails more than once.</span></span><br><span class="line">  <span class="keyword">let</span> failedBoundaries: <span class="built_in">Set</span>&lt;Fiber&gt; | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// Error boundaries that captured an error during the current commit.</span></span><br><span class="line">  <span class="keyword">let</span> commitPhaseBoundaries: <span class="built_in">Set</span>&lt;Fiber&gt; | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">let</span> firstUncaughtError: mixed | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">let</span> didFatal: boolean = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> isCommitting: boolean = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">let</span> isUnmounting: boolean = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Used for performance tracking.</span></span><br><span class="line">  <span class="keyword">let</span> interruptedBy: Fiber | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">resetContextStack</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Reset the stack</span></span><br><span class="line">    reset();</span><br><span class="line">    <span class="comment">// Reset the cursors</span></span><br><span class="line">    resetContext();</span><br><span class="line">    resetHostContainer();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>从这里开始，就很难再找到路线了。。。不知道得在FiberWork里慢慢找到答案</p>
<p>可以看到该函数顺序执行了</p>
<p>这几个函数也代表了Fiber的三个阶段的工作：Begin, Complete, Commit, 我们一个个看源码，来指导它们到底做了什么</p>
<p>ReactFiberHydrationContext</p>
<p>ReactFiberBeginWork</p>
<p>ReactFiberCompleteWork</p>
<p>ReactFiberCommitWork</p>
<hr>
<p><a href="https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberBeginWork.js" target="_blank" rel="noopener">https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberBeginWork.js</a></p>
<p>先介绍下优先级：<br>0-2，会直接再主线程内执行，<br>2-4， 会在window.requestAnimationFrame里循环，<br>5-6， 会在window.requestIdleCallback里循环</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">type PriorityLevel = <span class="number">0</span> | <span class="number">1</span> | <span class="number">2</span> | <span class="number">3</span> | <span class="number">4</span> | <span class="number">5</span> | <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line">NoWork: <span class="number">0</span>, <span class="comment">// No work is pending.</span></span><br><span class="line">SynchronousPriority: <span class="number">1</span>, <span class="comment">// For controlled text inputs. Synchronous side-effects.</span></span><br><span class="line">TaskPriority: <span class="number">2</span>, <span class="comment">// Completes at the end of the current tick.</span></span><br><span class="line">AnimationPriority: <span class="number">3</span>, <span class="comment">// Needs to complete before the next frame.</span></span><br><span class="line">HighPriority: <span class="number">4</span>, <span class="comment">// Interaction that needs to complete pretty soon to feel responsive.</span></span><br><span class="line">LowPriority: <span class="number">5</span>, <span class="comment">// Data fetching, or result from updating stores.</span></span><br><span class="line">OffscreenPriority: <span class="number">6</span>, <span class="comment">// Won't be visible but do the work in case it becomes visible.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">beginWork</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    current: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">    workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    renderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 当目前工作对象的expirationTime没有工作||工作的deadline超时时，马上调用bailoutOnLowPriority，将当前作业的优先级上调</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      workInProgress.expirationTime === NoWork ||</span><br><span class="line">      workInProgress.expirationTime &gt; renderExpirationTime</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">return</span> bailoutOnLowPriority(current, workInProgress);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (workInProgress.tag) &#123;</span><br><span class="line">      <span class="keyword">case</span> IndeterminateComponent:</span><br><span class="line">        <span class="keyword">return</span> mountIndeterminateComponent(</span><br><span class="line">          current,</span><br><span class="line">          workInProgress,</span><br><span class="line">          renderExpirationTime,</span><br><span class="line">        );</span><br><span class="line">      <span class="keyword">case</span> FunctionalComponent:</span><br><span class="line">        <span class="keyword">return</span> updateFunctionalComponent(current, workInProgress);</span><br><span class="line">      <span class="keyword">case</span> ClassComponent:</span><br><span class="line">        <span class="keyword">return</span> updateClassComponent(</span><br><span class="line">          current,</span><br><span class="line">          workInProgress,</span><br><span class="line">          renderExpirationTime,</span><br><span class="line">        );</span><br><span class="line">      <span class="keyword">case</span> HostRoot:</span><br><span class="line">        <span class="keyword">return</span> updateHostRoot(current, workInProgress, renderExpirationTime);</span><br><span class="line">      <span class="keyword">case</span> HostComponent:</span><br><span class="line">        <span class="keyword">return</span> updateHostComponent(</span><br><span class="line">          current,</span><br><span class="line">          workInProgress,</span><br><span class="line">          renderExpirationTime,</span><br><span class="line">        );</span><br><span class="line">      <span class="keyword">case</span> HostText:</span><br><span class="line">        <span class="keyword">return</span> updateHostText(current, workInProgress);</span><br><span class="line">      <span class="keyword">case</span> CallHandlerPhase:</span><br><span class="line">        <span class="comment">// This is a restart. Reset the tag to the initial phase.</span></span><br><span class="line">        workInProgress.tag = CallComponent;</span><br><span class="line">      <span class="comment">// Intentionally fall through since this is now the same.</span></span><br><span class="line">      <span class="keyword">case</span> CallComponent:</span><br><span class="line">        <span class="keyword">return</span> updateCallComponent(</span><br><span class="line">          current,</span><br><span class="line">          workInProgress,</span><br><span class="line">          renderExpirationTime,</span><br><span class="line">        );</span><br><span class="line">      <span class="keyword">case</span> ReturnComponent:</span><br><span class="line">        <span class="comment">// A return component is just a placeholder, we can just run through the</span></span><br><span class="line">        <span class="comment">// next one immediately.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">case</span> HostPortal:</span><br><span class="line">        <span class="keyword">return</span> updatePortalComponent(</span><br><span class="line">          current,</span><br><span class="line">          workInProgress,</span><br><span class="line">          renderExpirationTime,</span><br><span class="line">        );</span><br><span class="line">      <span class="keyword">case</span> Fragment:</span><br><span class="line">        <span class="keyword">return</span> updateFragment(current, workInProgress);</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        invariant(</span><br><span class="line">          <span class="literal">false</span>,</span><br><span class="line">          <span class="string">'Unknown unit of work tag. This error is likely caused by a bug in '</span> +</span><br><span class="line">            <span class="string">'React. Please file an issue.'</span>,</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>可见在一个Fiber周期里，这里就开始根据Fiber的tag来更新组件，也可见现在React的工作形式是把组件更新等操作封装为Fiber，然后通过Fiber调度算法来执行操作。</p>
<p>里面包括了服务器组件，函数式组件，以及一些其他操作, 在此阶段，Fiber将每个组件需要执行的工作打上Tag， 并请求Fiber请求插入队列并调度。</p>
<p>下面是一些组件介绍</p>
<p>Fragments<br>You can also return multiple items from render() using an array:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">render() &#123;</span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    &lt;li key=<span class="string">"A"</span>&gt;First item&lt;<span class="regexp">/li&gt;,</span></span><br><span class="line"><span class="regexp">    &lt;li key="B"&gt;Second item&lt;/</span>li&gt;,</span><br><span class="line">    &lt;li key=<span class="string">"C"</span>&gt;Third item&lt;<span class="regexp">/li&gt;,</span></span><br><span class="line"><span class="regexp">  ];</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>IndeterminateComponent</p>
<p>不定组件</p>
<p>FunctionComponent</p>
<p>函数式组件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">component</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &lt;div&gt;&lt;/div&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ClassComponent</p>
<p>类式组件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Component</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Components</span> </span>&#123;</span><br><span class="line">  constuctor (props )&#123;</span><br><span class="line">    <span class="keyword">super</span>(props)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>复习完毕，那么update函数的操作:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateClassComponent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    current: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">    workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    renderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Push context providers early to prevent context stack mismatches.</span></span><br><span class="line">    <span class="comment">// During mounting we don't know the child context yet as the instance doesn't exist.</span></span><br><span class="line">    <span class="comment">// We will invalidate the child context in finishClassComponent() right after rendering.</span></span><br><span class="line">    <span class="keyword">const</span> hasContext = pushContextProvider(workInProgress);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> shouldUpdate;</span><br><span class="line">    <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 如果当前作业没有实例，则初始化后，挂载实例</span></span><br><span class="line">      <span class="keyword">if</span> (!workInProgress.stateNode) &#123;</span><br><span class="line">        <span class="comment">// In the initial pass we might need to construct the instance.</span></span><br><span class="line">        <span class="comment">// 使用工作进程对象和工作中待处理的props数据，构造实例</span></span><br><span class="line">        constructClassInstance(workInProgress, workInProgress.pendingProps);</span><br><span class="line">        <span class="comment">// 将该实例加入Fiber作业队列</span></span><br><span class="line">        mountClassInstance(workInProgress, renderExpirationTime);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Simulate an async bailout/interruption by invoking lifecycle twice.</span></span><br><span class="line">        <span class="comment">// We do this here rather than inside of ReactFiberClassComponent,</span></span><br><span class="line">        <span class="comment">// To more realistically simulate the interruption behavior of async,</span></span><br><span class="line">        <span class="comment">// Which would never call componentWillMount() twice on the same instance.</span></span><br><span class="line">        <span class="keyword">if</span> (debugRenderPhaseSideEffects) &#123;</span><br><span class="line">          constructClassInstance(workInProgress, workInProgress.pendingProps);</span><br><span class="line">          mountClassInstance(workInProgress, renderExpirationTime);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将需要更新状态位置true</span></span><br><span class="line">        shouldUpdate = <span class="literal">true</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        invariant(<span class="literal">false</span>, <span class="string">'Resuming work not yet implemented.'</span>);</span><br><span class="line">        <span class="comment">// In a resume, we'll already have an instance we can reuse.</span></span><br><span class="line">        <span class="comment">// shouldUpdate = resumeMountClassInstance(workInProgress, renderExpirationTime);</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      shouldUpdate = updateClassInstance(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> finishClassComponent(</span><br><span class="line">      current,</span><br><span class="line">      workInProgress,</span><br><span class="line">      shouldUpdate,</span><br><span class="line">      hasContext,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">finishClassComponent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    current: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">    workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    shouldUpdate: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">    hasContext: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Refs should update even if shouldComponentUpdate returns false</span></span><br><span class="line">    markRef(current, workInProgress);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果component生命周期中，showUpdateComponentUpdate 返回false</span></span><br><span class="line">    <span class="keyword">if</span> (!shouldUpdate) &#123;</span><br><span class="line">      <span class="comment">// Context providers should defer to sCU for rendering</span></span><br><span class="line">      <span class="keyword">if</span> (hasContext) &#123;</span><br><span class="line">        invalidateContextProvider(workInProgress, <span class="literal">false</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 将当前已经完成的作业插入到待commit队列</span></span><br><span class="line">      <span class="keyword">return</span> bailoutOnAlreadyFinishedWork(current, workInProgress);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> instance = workInProgress.stateNode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Rerender</span></span><br><span class="line">    ReactCurrentOwner.current = workInProgress;</span><br><span class="line">    <span class="keyword">let</span> nextChildren;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      ReactDebugCurrentFiber.setCurrentPhase(<span class="string">'render'</span>);</span><br><span class="line">      nextChildren = instance.render();</span><br><span class="line">      <span class="keyword">if</span> (debugRenderPhaseSideEffects) &#123;</span><br><span class="line">        instance.render();</span><br><span class="line">      &#125;</span><br><span class="line">      ReactDebugCurrentFiber.setCurrentPhase(<span class="literal">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (debugRenderPhaseSideEffects) &#123;</span><br><span class="line">        instance.render();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// render返回当前实例的子对象</span></span><br><span class="line">      nextChildren = instance.render();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// React DevTools reads this flag.</span></span><br><span class="line">    workInProgress.effectTag |= PerformedWork;</span><br><span class="line">    reconcileChildren(current, workInProgress, nextChildren);</span><br><span class="line">    <span class="comment">// Memoize props and state using the values we just used to render.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Restructure so we never read values from the instance.</span></span><br><span class="line">    memoizeState(workInProgress, instance.state);</span><br><span class="line">    memoizeProps(workInProgress, instance.props);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The context might have changed so we need to recalculate it.</span></span><br><span class="line">    <span class="keyword">if</span> (hasContext) &#123;</span><br><span class="line">      invalidateContextProvider(workInProgress, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> workInProgress.child;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Functional Component 是没有自己的state属性的，所以当props改变的时候，只用考虑props对子组件的影响</span></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">updateFunctionalComponent</span>(<span class="params">current, workInProgress</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> fn = workInProgress.type;</span><br><span class="line">    <span class="keyword">const</span> nextProps = workInProgress.pendingProps;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果之前的props和pending中的props（需要处理的改变的props）相等，那么直接当次作业直接完成，因为props不变那么也不需要改变。</span></span><br><span class="line">    <span class="keyword">if</span> (hasContextChanged()) &#123;</span><br><span class="line">      <span class="comment">// Normally we can bail out on props equality but if context has changed</span></span><br><span class="line">      <span class="comment">// we don't do the bailout and we have to reuse existing props instead.</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (workInProgress.memoizedProps === nextProps) &#123;</span><br><span class="line">        <span class="keyword">return</span> bailoutOnAlreadyFinishedWork(current, workInProgress);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> consider bringing fn.shouldComponentUpdate() back.</span></span><br><span class="line">      <span class="comment">// It used to be here.</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果props发生改变，那么就执行下面的语句，将子组件的update操作放到下一队列中</span></span><br><span class="line">    <span class="keyword">const</span> unmaskedContext = getUnmaskedContext(workInProgress);</span><br><span class="line">    <span class="keyword">const</span> context = getMaskedContext(workInProgress, unmaskedContext);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> nextChildren;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      ReactCurrentOwner.current = workInProgress;</span><br><span class="line">      ReactDebugCurrentFiber.setCurrentPhase(<span class="string">'render'</span>);</span><br><span class="line">      nextChildren = fn(nextProps, context);</span><br><span class="line">      ReactDebugCurrentFiber.setCurrentPhase(<span class="literal">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      nextChildren = fn(nextProps, context);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// React DevTools reads this flag.</span></span><br><span class="line">    workInProgress.effectTag |= PerformedWork;</span><br><span class="line">    reconcileChildren(current, workInProgress, nextChildren);</span><br><span class="line">    memoizeProps(workInProgress, nextProps);</span><br><span class="line">    <span class="keyword">return</span> workInProgress.child;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">memoizeProps</span>(<span class="params">workInProgress: Fiber, nextProps: any</span>) </span>&#123;</span><br><span class="line">    workInProgress.memoizedProps = nextProps;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reconcileChildren</span>(<span class="params">current, workInProgress, nextChildren</span>) </span>&#123;</span><br><span class="line">    reconcileChildrenAtExpirationTime(</span><br><span class="line">      current,</span><br><span class="line">      workInProgress,</span><br><span class="line">      nextChildren,</span><br><span class="line">      workInProgress.expirationTime,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">reconcileChildrenAtExpirationTime</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    current,</span></span></span><br><span class="line"><span class="function"><span class="params">    workInProgress,</span></span></span><br><span class="line"><span class="function"><span class="params">    nextChildren,</span></span></span><br><span class="line"><span class="function"><span class="params">    renderExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// If this is a fresh new component that hasn't been rendered yet, we</span></span><br><span class="line">      <span class="comment">// won't update its child set by applying minimal side-effects. Instead,</span></span><br><span class="line">      <span class="comment">// we will add them all to the child before it gets rendered. That means</span></span><br><span class="line">      <span class="comment">// we can optimize this reconciliation pass by not tracking side-effects.</span></span><br><span class="line">      workInProgress.child = mountChildFibers(</span><br><span class="line">        workInProgress,</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        nextChildren,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// If the current child is the same as the work in progress, it means that</span></span><br><span class="line">      <span class="comment">// we haven't yet started any work on these children. Therefore, we use</span></span><br><span class="line">      <span class="comment">// the clone algorithm to create a copy of all the current children.</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// If we had any progressed work already, that is invalid at this point so</span></span><br><span class="line">      <span class="comment">// let's throw it out.</span></span><br><span class="line">      workInProgress.child = reconcileChildFibers(</span><br><span class="line">        workInProgress,</span><br><span class="line">        current.child,</span><br><span class="line">        nextChildren,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><a href="https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactChildFiber.js" target="_blank" rel="noopener">https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactChildFiber.js</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reconcileChildFibers</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentFirstChild: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">    newChild: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="comment">// This function is not recursive.</span></span><br><span class="line">    <span class="comment">// If the top level item is an array, we treat it as a set of children,</span></span><br><span class="line">    <span class="comment">// not as a fragment. Nested arrays on the other hand will be treated as</span></span><br><span class="line">    <span class="comment">// fragment nodes. Recursion happens at the normal flow.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handle top level unkeyed fragments as if they were arrays.</span></span><br><span class="line">    <span class="comment">// This leads to an ambiguity between &lt;&gt;&#123;[...]&#125;&lt;/&gt; and &lt;&gt;...&lt;/&gt;.</span></span><br><span class="line">    <span class="comment">// We treat the ambiguous cases above the same.</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      <span class="keyword">typeof</span> newChild === <span class="string">'object'</span> &amp;&amp;</span><br><span class="line">      newChild !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">      newChild.type === REACT_FRAGMENT_TYPE &amp;&amp;</span><br><span class="line">      newChild.key === <span class="literal">null</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      newChild = newChild.props.children;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handle object types</span></span><br><span class="line">    <span class="keyword">const</span> isObject = <span class="keyword">typeof</span> newChild === <span class="string">'object'</span> &amp;&amp; newChild !== <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果子组件不同，则替换子组件, 将替换的组件放到队列中</span></span><br><span class="line">    <span class="keyword">if</span> (isObject) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (newChild.$$<span class="keyword">typeof</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> REACT_ELEMENT_TYPE:</span><br><span class="line">          <span class="keyword">return</span> placeSingleChild(</span><br><span class="line">            reconcileSingleElement(</span><br><span class="line">              returnFiber,</span><br><span class="line">              currentFirstChild,</span><br><span class="line">              newChild,</span><br><span class="line">              expirationTime,</span><br><span class="line">            ),</span><br><span class="line">          );</span><br><span class="line">        <span class="keyword">case</span> REACT_PORTAL_TYPE:</span><br><span class="line">          <span class="keyword">return</span> placeSingleChild(</span><br><span class="line">            reconcileSinglePortal(</span><br><span class="line">              returnFiber,</span><br><span class="line">              currentFirstChild,</span><br><span class="line">              newChild,</span><br><span class="line">              expirationTime,</span><br><span class="line">            ),</span><br><span class="line">          );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果子组件为string||number（应该是div中只改变了string或者数字）， 则替换其中的数字或者字符串即可</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">'string'</span> || <span class="keyword">typeof</span> newChild === <span class="string">'number'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> placeSingleChild(</span><br><span class="line">        reconcileSingleTextNode(</span><br><span class="line">          returnFiber,</span><br><span class="line">          currentFirstChild,</span><br><span class="line">          <span class="string">''</span> + newChild,</span><br><span class="line">          expirationTime,</span><br><span class="line">        ),</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果为数组，则默认按照子组件数组处理</span></span><br><span class="line">    <span class="keyword">if</span> (isArray(newChild)) &#123;</span><br><span class="line">      <span class="keyword">return</span> reconcileChildrenArray(</span><br><span class="line">        returnFiber,</span><br><span class="line">        currentFirstChild,</span><br><span class="line">        newChild,</span><br><span class="line">        expirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (getIteratorFn(newChild)) &#123;</span><br><span class="line">      <span class="keyword">return</span> reconcileChildrenIterator(</span><br><span class="line">        returnFiber,</span><br><span class="line">        currentFirstChild,</span><br><span class="line">        newChild,</span><br><span class="line">        expirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isObject) &#123;</span><br><span class="line">      throwOnInvalidObjectType(returnFiber, newChild);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">'function'</span>) &#123;</span><br><span class="line">        warnOnFunctionType();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">      <span class="comment">// If the new child is undefined, and the return fiber is a composite</span></span><br><span class="line">      <span class="comment">// component, throw an error. If Fiber return types are disabled,</span></span><br><span class="line">      <span class="comment">// we already threw above.</span></span><br><span class="line">      <span class="keyword">switch</span> (returnFiber.tag) &#123;</span><br><span class="line">        <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">          <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">            <span class="keyword">const</span> instance = returnFiber.stateNode;</span><br><span class="line">            <span class="keyword">if</span> (instance.render._isMockFunction) &#123;</span><br><span class="line">              <span class="comment">// We allow auto-mocks to proceed as if they're returning null.</span></span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Intentionally fall through to the next case, which handles both</span></span><br><span class="line">        <span class="comment">// functions and classes</span></span><br><span class="line">        <span class="comment">// eslint-disable-next-lined no-fallthrough</span></span><br><span class="line">        <span class="keyword">case</span> FunctionalComponent: &#123;</span><br><span class="line">          <span class="keyword">const</span> Component = returnFiber.type;</span><br><span class="line">          invariant(</span><br><span class="line">            <span class="literal">false</span>,</span><br><span class="line">            <span class="string">'%s(...): Nothing was returned from render. This usually means a '</span> +</span><br><span class="line">              <span class="string">'return statement is missing. Or, to render nothing, '</span> +</span><br><span class="line">              <span class="string">'return null.'</span>,</span><br><span class="line">            Component.displayName || Component.name || <span class="string">'Component'</span>,</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remaining cases are all treated as empty.</span></span><br><span class="line">    <span class="keyword">return</span> deleteRemainingChildren(returnFiber, currentFirstChild);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 这里在分析完需要执行的操作后，只需要打上一个影响标签，在commit阶段再执行， 这里打上了一个Placement，意为替换</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">placeSingleChild</span>(<span class="params">newFiber: Fiber</span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">    <span class="comment">// This is simpler for the single child case. We only need to do a</span></span><br><span class="line">    <span class="comment">// placement for inserting new children.</span></span><br><span class="line">    <span class="keyword">if</span> (shouldTrackSideEffects &amp;&amp; newFiber.alternate === <span class="literal">null</span>) &#123;</span><br><span class="line">      newFiber.effectTag = Placement;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newFiber;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><a href="https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberCompleteWork.js" target="_blank" rel="noopener">https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberCompleteWork.js</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">appendAllReturns</span>(<span class="params">returns: Array&lt;mixed&gt;, workInProgress: Fiber</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> node = workInProgress.stateNode;</span><br><span class="line">    <span class="keyword">if</span> (node) &#123;</span><br><span class="line">      node.return = workInProgress;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (node !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        node.tag === HostComponent ||</span><br><span class="line">        node.tag === HostText ||</span><br><span class="line">        node.tag === HostPortal</span><br><span class="line">      ) &#123;</span><br><span class="line">        invariant(<span class="literal">false</span>, <span class="string">'A call cannot have host component children.'</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.tag === ReturnComponent) &#123;</span><br><span class="line">        returns.push(node.pendingProps.value);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.child !== <span class="literal">null</span>) &#123;</span><br><span class="line">        node.child.return = node;</span><br><span class="line">        node = node.child;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> (node.sibling === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果node没有sibiling和return，那么我们就到达了下一次循环的根节点</span></span><br><span class="line">        <span class="keyword">if</span> (node.return === <span class="literal">null</span> || node.return === workInProgress) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        node = node.return;</span><br><span class="line">      &#125;</span><br><span class="line">      node.sibling.return = node.return;</span><br><span class="line">      node = node.sibling;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">moveCallToHandlerPhase</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    current: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">    workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    renderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> props = workInProgress.memoizedProps;</span><br><span class="line">    invariant(</span><br><span class="line">      props,</span><br><span class="line">      <span class="string">'Should be resolved by now. This error is likely caused by a bug in '</span> +</span><br><span class="line">        <span class="string">'React. Please file an issue.'</span>,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// First step of the call has completed. Now we need to do the second.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> It would be nice to have a multi stage call represented by a</span></span><br><span class="line">    <span class="comment">// single component, or at least tail call optimize nested ones. Currently</span></span><br><span class="line">    <span class="comment">// that requires additional fields that we don't want to add to the fiber.</span></span><br><span class="line">    <span class="comment">// So this requires nested handlers.</span></span><br><span class="line">    <span class="comment">// Note: This doesn't mutate the alternate node. I don't think it needs to</span></span><br><span class="line">    <span class="comment">// since this stage is reset for every pass.</span></span><br><span class="line">    workInProgress.tag = CallHandlerPhase;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Build up the returns.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Compare this to a generator or opaque helpers like Children.</span></span><br><span class="line">    <span class="keyword">const</span> returns: <span class="built_in">Array</span>&lt;mixed&gt; = [];</span><br><span class="line">    appendAllReturns(returns, workInProgress);</span><br><span class="line">    <span class="keyword">const</span> fn = props.handler;</span><br><span class="line">    <span class="keyword">const</span> childProps = props.props;</span><br><span class="line">    <span class="keyword">const</span> nextChildren = fn(childProps, returns);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> currentFirstChild = current !== <span class="literal">null</span> ? current.child : <span class="literal">null</span>;</span><br><span class="line">    workInProgress.child = reconcileChildFibers(</span><br><span class="line">      workInProgress,</span><br><span class="line">      currentFirstChild,</span><br><span class="line">      nextChildren,</span><br><span class="line">      renderExpirationTime,</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> workInProgress.child;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">appendAllChildren</span>(<span class="params">parent: I, workInProgress: Fiber</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// We only have the top Fiber that was created but we need recurse down its</span></span><br><span class="line">    <span class="comment">// children to find all the terminal nodes.</span></span><br><span class="line">    <span class="keyword">let</span> node = workInProgress.child;</span><br><span class="line">    <span class="keyword">while</span> (node !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (node.tag === HostComponent || node.tag === HostText) &#123;</span><br><span class="line">        appendInitialChild(parent, node.stateNode);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.tag === HostPortal) &#123;</span><br><span class="line">        <span class="comment">// If we have a portal child, then we don't want to traverse</span></span><br><span class="line">        <span class="comment">// down its children. Instead, we'll get insertions from each child in</span></span><br><span class="line">        <span class="comment">// the portal directly.</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.child !== <span class="literal">null</span>) &#123;</span><br><span class="line">        node.child.return = node;</span><br><span class="line">        node = node.child;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (node === workInProgress) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> (node.sibling === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (node.return === <span class="literal">null</span> || node.return === workInProgress) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        node = node.return;</span><br><span class="line">      &#125;</span><br><span class="line">      node.sibling.return = node.return;</span><br><span class="line">      node = node.sibling;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">completeWork</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    current: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">    workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    renderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 传入一个Fiber，将其从bengin状态转化为Complete状态</span></span><br><span class="line">    <span class="keyword">const</span> newProps = workInProgress.pendingProps;</span><br><span class="line">    <span class="comment">// 当前工作进程处理的props</span></span><br><span class="line">    <span class="comment">// 根据目前处理的Fiber类型，做出不同的操作，这里忽略了Host相关的操作</span></span><br><span class="line">    <span class="keyword">switch</span> (workInProgress.tag) &#123;</span><br><span class="line">      <span class="keyword">case</span> FunctionalComponent:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">        <span class="comment">// We are leaving this subtree, so pop context if any.</span></span><br><span class="line">        popContextProvider(workInProgress);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> CallComponent:</span><br><span class="line">        <span class="keyword">return</span> moveCallToHandlerPhase(</span><br><span class="line">          current,</span><br><span class="line">          workInProgress,</span><br><span class="line">          renderExpirationTime,</span><br><span class="line">        );</span><br><span class="line">      <span class="keyword">case</span> CallHandlerPhase:</span><br><span class="line">        <span class="comment">// Reset the tag to now be a first phase call.</span></span><br><span class="line">        workInProgress.tag = CallComponent;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">case</span> ReturnComponent:</span><br><span class="line">        <span class="comment">// Does nothing.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">case</span> Fragment:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">case</span> IndeterminateComponent:</span><br><span class="line">        invariant(</span><br><span class="line">          <span class="literal">false</span>,</span><br><span class="line">          <span class="string">'An indeterminate component should have become determinate before '</span> +</span><br><span class="line">            <span class="string">'completing. This error is likely caused by a bug in React. Please '</span> +</span><br><span class="line">            <span class="string">'file an issue.'</span>,</span><br><span class="line">        );</span><br><span class="line">      <span class="comment">// eslint-disable-next-line no-fallthrough</span></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        invariant(</span><br><span class="line">          <span class="literal">false</span>,</span><br><span class="line">          <span class="string">'Unknown unit of work tag. This error is likely caused by a bug in '</span> +</span><br><span class="line">            <span class="string">'React. Please file an issue.'</span>,</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><a href="https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberCommitWork.js" target="_blank" rel="noopener">https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberCommitWork.js</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitLifeCycles</span>(<span class="params">current: Fiber | null, finishedWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (finishedWork.tag) &#123;</span><br><span class="line">      <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">        <span class="keyword">const</span> instance = finishedWork.stateNode;</span><br><span class="line">        <span class="keyword">if</span> (finishedWork.effectTag &amp; Update) &#123;</span><br><span class="line">          <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">            startPhaseTimer(finishedWork, <span class="string">'componentDidMount'</span>);</span><br><span class="line">            instance.props = finishedWork.memoizedProps;</span><br><span class="line">            instance.state = finishedWork.memoizedState;</span><br><span class="line">            instance.componentDidMount();</span><br><span class="line">            stopPhaseTimer();</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> prevProps = current.memoizedProps;</span><br><span class="line">            <span class="keyword">const</span> prevState = current.memoizedState;</span><br><span class="line">            startPhaseTimer(finishedWork, <span class="string">'componentDidUpdate'</span>);</span><br><span class="line">            instance.props = finishedWork.memoizedProps;</span><br><span class="line">            instance.state = finishedWork.memoizedState;</span><br><span class="line">            <span class="comment">// 这里可以看到，为什么再componentDidUpdate的setState可以调用到prevProps和prevState了</span></span><br><span class="line">            instance.componentDidUpdate(prevProps, prevState);</span><br><span class="line">            stopPhaseTimer();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> updateQueue = finishedWork.updateQueue;</span><br><span class="line">        <span class="keyword">if</span> (updateQueue !== <span class="literal">null</span>) &#123;</span><br><span class="line">          commitCallbacks(updateQueue, instance);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="http://makersden.io/blog/look-inside-fiber/" target="_blank" rel="noopener">http://makersden.io/blog/look-inside-fiber/</a></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-12-28</span><i class="fa fa-tag"></i><a href="/tags/前端/" title="前端" class="tag">前端 </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://yoursite.com/2017/12/28/React-源码解读路线-0/,陪月书的博客,React 源码解读路线[0],;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a role="navigation" href="/2017/12/28/搞清楚算法复杂度/" title="搞清楚算法复杂度" class="btn">下一篇</a></li></ul></div><a id="comments"></a><div id="vcomments" style="margin:0 30px;"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/gh/xcss/valine@v1.1.7/dist/Valine.min.js?v=undefined"></script><script>var valine = new Valine({
  el:'#vcomments',
  notify:false || false, 
  verify:false|| false, 
  app_id:'rqu357CKMidPy7qDuGt8zzwm-gzGzoHsz',
  app_key:'VXuNpxAGc5itkNDLdWWm9h31',
  placeholder:'Post a comment',
  path: window.location.pathname,
  avatar:'mm'
})</script></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>
<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="陪月书"><title>React 源码解读路线[0] · 陪月书的博客</title><meta name="description" content="每次看这种框架的源码的时候，都让人感觉摸不着头脑，不过我们可以通过我们平时的使用，来一步步了解React的实现。使用深度优先搜索来学习这个
从最简单的开始：

使用ReactDom, 在id=root的dom节点上插入h1,我们去看源码的声明

12345ReactDOM.render(  &amp;lt;"><meta name="keywords" content="Web, FE, MachineLearning, DeepLearning"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">陪月书的博客</a></h3><div class="description"><p>有的人20岁就死了，80岁才埋</p></div></div></div><ul class="social-links"><li><a href="http://github.com/Yulight1401"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img src="/images/myIcon.jpeg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>React 源码解读路线[0]</a></h3></div><div class="post-content"><p>每次看这种框架的源码的时候，都让人感觉摸不着头脑，不过我们可以通过我们平时的使用，来一步步了解React的实现。使用深度优先搜索来学习这个</p>
<p>从最简单的开始：</p>
<blockquote>
<p>使用ReactDom, 在id=root的dom节点上插入h1,我们去看源码的声明</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;h1&gt;Hello, world!&lt;/h1&gt;,</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">'root'</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>源码地址: <a href="https://github.com/facebook/react/blob/master/packages/react-dom/src/client/ReactDOM.js" target="_blank" rel="noopener">https://github.com/facebook/react/blob/master/packages/react-dom/src/client/ReactDOM.js</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ReactDOM: <span class="built_in">Object</span> = &#123;</span><br><span class="line"> ...</span><br><span class="line"> render(</span><br><span class="line">    element: React$Element&lt;any&gt;, <span class="comment">// any为flow的类型检查，即任何类型的ReactElement</span></span><br><span class="line">    container: DOMContainer, <span class="comment">// DomContainer类型</span></span><br><span class="line">    callback: ?<span class="built_in">Function</span>, <span class="comment">// ?为flow的optional，类型为Function 选填</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> legacyRenderSubtreeIntoContainer(</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      element,</span><br><span class="line">      container,</span><br><span class="line">      <span class="literal">false</span>,</span><br><span class="line">      callback,</span><br><span class="line">    );</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>官方解释:</p>
<p>Render a React element into the DOM in the supplied container and return a reference to the component (or returns null for stateless components).</p>
<p>If the React element was previously rendered into container, this will perform an update on it and only mutate the DOM as necessary to reflect the latest React element.</p>
<p>If the optional callback is provided, it will be executed after the component is rendered or updated.</p>
<p>可以很直接， 可见初始化时，又调用了legacyRenderSubtreeIntoContainer这个函数，接着看</p>
<hr>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">legacyRenderSubtreeIntoContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  parentComponent: ?React$Component&lt;any, any&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  children: ReactNodeList,</span></span></span><br><span class="line"><span class="function"><span class="params">  container: DOMContainer,</span></span></span><br><span class="line"><span class="function"><span class="params">  forceHydrate: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback: ?Function,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Ensure all entry points contain this check</span></span><br><span class="line">  invariant(</span><br><span class="line">    isValidContainer(container),</span><br><span class="line">    <span class="string">'Target container is not a DOM element.'</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    topLevelUpdateWarnings(container);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Without `any` type, Flow says "Property cannot be accessed on any</span></span><br><span class="line">  <span class="comment">// member of intersection type." Whyyyyyy.</span></span><br><span class="line">  <span class="keyword">let</span> root: Root = (container._reactRootContainer: any);<span class="comment">// 获取根</span></span><br><span class="line">  <span class="comment">// 如果root没有实例化过，则实例化，防止被重复调用</span></span><br><span class="line">  <span class="keyword">if</span> (!root) &#123;</span><br><span class="line">    <span class="comment">// Initial mount</span></span><br><span class="line">    root = container._reactRootContainer = legacyCreateRootFromDOMContainer(</span><br><span class="line">      container,</span><br><span class="line">      forceHydrate,</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// 如果有callback，则包装一层</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> callback === <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> originalCallback = callback;</span><br><span class="line">      callback = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> instance = DOMRenderer.getPublicRootInstance(root._internalRoot);</span><br><span class="line">        originalCallback.call(instance);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Initial mount should not be batched.</span></span><br><span class="line">    DOMRenderer.unbatchedUpdates(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (parentComponent != <span class="literal">null</span>) &#123;</span><br><span class="line">        root.legacy_renderSubtreeIntoContainer(</span><br><span class="line">          parentComponent,</span><br><span class="line">          children,</span><br><span class="line">          callback,</span><br><span class="line">        );</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        root.render(children, callback);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 已经有实例的化</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> callback === <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> originalCallback = callback;</span><br><span class="line">      callback = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> instance = DOMRenderer.getPublicRootInstance(root._internalRoot);</span><br><span class="line">        originalCallback.call(instance);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 直接Update</span></span><br><span class="line">    <span class="keyword">if</span> (parentComponent != <span class="literal">null</span>) &#123;</span><br><span class="line">      root.legacy_renderSubtreeIntoContainer(</span><br><span class="line">        parentComponent,</span><br><span class="line">        children,</span><br><span class="line">        callback,</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      root.render(children, callback);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 返回根节点实例</span></span><br><span class="line">  <span class="keyword">return</span> DOMRenderer.getPublicRootInstance(root._internalRoot);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可见根节点为包装对象，调用render时，先判断是否已经实例化了，没有就由legacyCreateRootFromDOMContainer创建，有的化就直接更新。接下来可以看看它时如何更新的：我们可以直接找root.legacy_renderSubtreeIntoContainer</p>
<hr>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ReactRoot.prototype.legacy_renderSubtreeIntoContainer = <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  parentComponent: ?React$Component&lt;any, any&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  children: ReactNodeList,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback: ?(</span>) =&gt; <span class="title">mixed</span>,</span></span><br><span class="line"><span class="function">): <span class="title">Work</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> root = <span class="keyword">this</span>._internalRoot;</span><br><span class="line">  <span class="keyword">const</span> work = <span class="keyword">new</span> ReactWork();</span><br><span class="line">  callback = callback === <span class="literal">undefined</span> ? <span class="literal">null</span> : callback;</span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    warnOnInvalidCallback(callback, <span class="string">'render'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">    work.then(callback);</span><br><span class="line">  &#125;</span><br><span class="line">  DOMRenderer.updateContainer(children, root, parentComponent, work._onCommit);</span><br><span class="line">  <span class="keyword">return</span> work;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我们还需要再找DOMRenderer.updateContainer，继续</p>
<hr>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> DOMRenderer = ReactFiberReconciler(&#123;.../</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ReactFiberReconciler <span class="keyword">from</span> <span class="string">'react-reconciler'</span>;</span><br></pre></td></tr></table></figure>
<p>在DOMRenderer没有中找到updateContianer, 那么它一定在ReactFiberReconciler里，继续</p>
<hr>
<p><a href="https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberReconciler.js" target="_blank" rel="noopener">https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberReconciler.js</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">updateContainer(</span><br><span class="line">      element: ReactNodeList,</span><br><span class="line">      container: OpaqueRoot,</span><br><span class="line">      parentComponent: ?React$Component&lt;any, any&gt;,</span><br><span class="line">      callback: ?<span class="built_in">Function</span>,</span><br><span class="line">    ): ExpirationTime &#123;</span><br><span class="line">      <span class="keyword">const</span> current = container.current;</span><br><span class="line">      <span class="keyword">const</span> expirationTime = computeExpirationForFiber(current);</span><br><span class="line">      <span class="keyword">return</span> updateContainerAtExpirationTime(</span><br><span class="line">        element,</span><br><span class="line">        container,</span><br><span class="line">        parentComponent,</span><br><span class="line">        expirationTime,</span><br><span class="line">        callback,</span><br><span class="line">      );</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>
<p>可见这个函数只计算了Fiber算法所需要的时间参数，真正渲染的是updateContainerAtExpirationTime,以实现fiber算法。</p>
<hr>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateContainerAtExpirationTime</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    element: ReactNodeList,</span></span></span><br><span class="line"><span class="function"><span class="params">    container: OpaqueRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">    parentComponent: ?React$Component&lt;any, any&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">    expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params">    callback: ?Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>) </span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> If this is a nested container, this won't be the root.</span></span><br><span class="line">    <span class="keyword">const</span> current = container.current;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="keyword">if</span> (ReactFiberInstrumentation.debugTool) &#123;</span><br><span class="line">        <span class="keyword">if</span> (current.alternate === <span class="literal">null</span>) &#123;</span><br><span class="line">          ReactFiberInstrumentation.debugTool.onMountContainer(container);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (element === <span class="literal">null</span>) &#123;</span><br><span class="line">          ReactFiberInstrumentation.debugTool.onUnmountContainer(container);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          ReactFiberInstrumentation.debugTool.onUpdateContainer(container);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> context = getContextForSubtree(parentComponent);</span><br><span class="line">    <span class="keyword">if</span> (container.context === <span class="literal">null</span>) &#123;</span><br><span class="line">      container.context = context;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      container.pendingContext = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> scheduleRootUpdate(current, element, expirationTime, callback);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>接着看scheduleRootUpdate</p>
<hr>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">scheduleRootUpdate</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    current: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    element: ReactNodeList,</span></span></span><br><span class="line"><span class="function"><span class="params">    expirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params">    callback: ?Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        ReactDebugCurrentFiber.phase === <span class="string">'render'</span> &amp;&amp;</span><br><span class="line">        ReactDebugCurrentFiber.current !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        !didWarnAboutNestedUpdates</span><br><span class="line">      ) &#123;</span><br><span class="line">        didWarnAboutNestedUpdates = <span class="literal">true</span>;</span><br><span class="line">        warning(</span><br><span class="line">          <span class="literal">false</span>,</span><br><span class="line">          <span class="string">'Render methods should be a pure function of props and state; '</span> +</span><br><span class="line">            <span class="string">'triggering nested component updates from render is not allowed. '</span> +</span><br><span class="line">            <span class="string">'If necessary, trigger nested updates in componentDidUpdate.\n\n'</span> +</span><br><span class="line">            <span class="string">'Check the render method of %s.'</span>,</span><br><span class="line">          getComponentName(ReactDebugCurrentFiber.current) || <span class="string">'Unknown'</span>,</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    callback = callback === <span class="literal">undefined</span> ? <span class="literal">null</span> : callback;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      warning(</span><br><span class="line">        callback === <span class="literal">null</span> || <span class="keyword">typeof</span> callback === <span class="string">'function'</span>,</span><br><span class="line">        <span class="string">'render(...): Expected the last optional `callback` argument to be a '</span> +</span><br><span class="line">          <span class="string">'function. Instead received: %s.'</span>,</span><br><span class="line">        callback,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> update = &#123;</span><br><span class="line">      expirationTime,</span><br><span class="line">      partialState: &#123;element&#125;,</span><br><span class="line">      callback,</span><br><span class="line">      isReplace: <span class="literal">false</span>,</span><br><span class="line">      isForced: <span class="literal">false</span>,</span><br><span class="line">      next: <span class="literal">null</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    insertUpdateIntoFiber(current, update);</span><br><span class="line">    scheduleWork(current, expirationTime);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> expirationTime;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>查找 scheduleWork</p>
<hr>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">    computeUniqueAsyncExpiration,</span><br><span class="line">    computeExpirationForFiber,</span><br><span class="line">    scheduleWork,</span><br><span class="line">    requestWork,</span><br><span class="line">    flushRoot,</span><br><span class="line">    batchedUpdates,</span><br><span class="line">    unbatchedUpdates,</span><br><span class="line">    flushSync,</span><br><span class="line">    deferredUpdates,</span><br><span class="line">  &#125; = ReactFiberScheduler(config);</span><br></pre></td></tr></table></figure>
<hr>
<p>查找 ReactFiberScheduler</p>
<hr>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>&lt;<span class="title">T</span>, <span class="title">P</span>, <span class="title">I</span>, <span class="title">TI</span>, <span class="title">HI</span>, <span class="title">PI</span>, <span class="title">C</span>, <span class="title">CC</span>, <span class="title">CX</span>, <span class="title">PL</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  config: HostConfig&lt;T, P, I, TI, HI, PI, C, CC, CX, PL&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> hostContext = ReactFiberHostContext(config);</span><br><span class="line">  <span class="keyword">const</span> hydrationContext: HydrationContext&lt;C, CX&gt; = ReactFiberHydrationContext(</span><br><span class="line">    config,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> &#123;popHostContainer, popHostContext, resetHostContainer&#125; = hostContext;</span><br><span class="line">  <span class="keyword">const</span> &#123;beginWork, beginFailedWork&#125; = ReactFiberBeginWork(</span><br><span class="line">    config,</span><br><span class="line">    hostContext,</span><br><span class="line">    hydrationContext,</span><br><span class="line">    scheduleWork,</span><br><span class="line">    computeExpirationForFiber,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> &#123;completeWork&#125; = ReactFiberCompleteWork(</span><br><span class="line">    config,</span><br><span class="line">    hostContext,</span><br><span class="line">    hydrationContext,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    commitResetTextContent,</span><br><span class="line">    commitPlacement,</span><br><span class="line">    commitDeletion,</span><br><span class="line">    commitWork,</span><br><span class="line">    commitLifeCycles,</span><br><span class="line">    commitAttachRef,</span><br><span class="line">    commitDetachRef,</span><br><span class="line">  &#125; = ReactFiberCommitWork(config, captureError);</span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    now,</span><br><span class="line">    scheduleDeferredCallback,</span><br><span class="line">    cancelDeferredCallback,</span><br><span class="line">    useSyncScheduling,</span><br><span class="line">    prepareForCommit,</span><br><span class="line">    resetAfterCommit,</span><br><span class="line">  &#125; = config;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Represents the current time in ms.</span></span><br><span class="line">  <span class="keyword">const</span> startTime = now();</span><br><span class="line">  <span class="keyword">let</span> mostRecentCurrentTime: ExpirationTime = msToExpirationTime(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Used to ensure computeUniqueAsyncExpiration is monotonically increases.</span></span><br><span class="line">  <span class="keyword">let</span> lastUniqueAsyncExpiration: number = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Represents the expiration time that incoming updates should use. (If this</span></span><br><span class="line">  <span class="comment">// is NoWork, use the default strategy: async updates in async mode, sync</span></span><br><span class="line">  <span class="comment">// updates in sync mode.)</span></span><br><span class="line">  <span class="keyword">let</span> expirationContext: ExpirationTime = NoWork;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> isWorking: boolean = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The next work in progress fiber that we're currently working on.</span></span><br><span class="line">  <span class="keyword">let</span> nextUnitOfWork: Fiber | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">let</span> nextRoot: FiberRoot | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// The time at which we're currently rendering work.</span></span><br><span class="line">  <span class="keyword">let</span> nextRenderExpirationTime: ExpirationTime = NoWork;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The next fiber with an effect that we're currently committing.</span></span><br><span class="line">  <span class="keyword">let</span> nextEffect: Fiber | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Keep track of which fibers have captured an error that need to be handled.</span></span><br><span class="line">  <span class="comment">// Work is removed from this collection after componentDidCatch is called.</span></span><br><span class="line">  <span class="keyword">let</span> capturedErrors: <span class="built_in">Map</span>&lt;Fiber, CapturedError&gt; | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// Keep track of which fibers have failed during the current batch of work.</span></span><br><span class="line">  <span class="comment">// This is a different set than capturedErrors, because it is not reset until</span></span><br><span class="line">  <span class="comment">// the end of the batch. This is needed to propagate errors correctly if a</span></span><br><span class="line">  <span class="comment">// subtree fails more than once.</span></span><br><span class="line">  <span class="keyword">let</span> failedBoundaries: <span class="built_in">Set</span>&lt;Fiber&gt; | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// Error boundaries that captured an error during the current commit.</span></span><br><span class="line">  <span class="keyword">let</span> commitPhaseBoundaries: <span class="built_in">Set</span>&lt;Fiber&gt; | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">let</span> firstUncaughtError: mixed | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">let</span> didFatal: boolean = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> isCommitting: boolean = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">let</span> isUnmounting: boolean = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Used for performance tracking.</span></span><br><span class="line">  <span class="keyword">let</span> interruptedBy: Fiber | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">resetContextStack</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Reset the stack</span></span><br><span class="line">    reset();</span><br><span class="line">    <span class="comment">// Reset the cursors</span></span><br><span class="line">    resetContext();</span><br><span class="line">    resetHostContainer();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>从这里开始，就很难再找到路线了。。。得在FiberWork里慢慢找到答案</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-12-28</span><i class="fa fa-tag"></i><a href="/tags/前端/" title="前端" class="tag">前端 </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://yoursite.com/2017/12/28/React-源码解读路线-0/,陪月书的博客,React 源码解读路线[0],;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a role="navigation" href="/2017/12/28/搞清楚算法复杂度/" title="搞清楚算法复杂度" class="btn">下一篇</a></li></ul></div><a id="comments"></a><div id="vcomments" style="margin:0 30px;"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/gh/xcss/valine@v1.1.7/dist/Valine.min.js?v=undefined"></script><script>var valine = new Valine({
  el:'#vcomments',
  notify:false || false, 
  verify:false|| false, 
  app_id:'rqu357CKMidPy7qDuGt8zzwm-gzGzoHsz',
  app_key:'VXuNpxAGc5itkNDLdWWm9h31',
  placeholder:'Post a comment',
  path: window.location.pathname,
  avatar:'mm'
})</script></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>